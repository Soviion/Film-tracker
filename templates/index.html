<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π —Ç—Ä–µ–∫–µ—Ä —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üé¨ –ú–æ–π —Ç—Ä–µ–∫–µ—Ä —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤</h1>

        <div class="search">
            <h2>üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫</h2>
            <div class="search-form">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="query">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="query" placeholder="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: Matrix, Breaking Bad, –ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä..." required>
                    </div>

                    <div class="form-group">
                        <label for="type">–¢–∏–ø</label>
                        <select id="type">
                            <option value="">–õ—é–±–æ–π</option>
                            <option value="movie">–§–∏–ª—å–º</option>
                            <option value="series">–°–µ—Ä–∏–∞–ª</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="year">–ì–æ–¥</label>
                        <select id="year">
                            <option value="">–õ—é–±–æ–π</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                            <option value="2010">2010-–µ</option>
                            <option value="2000">2000-–µ</option>
                            <option value="1990">1990-–µ</option>
                            <option value="1980">1980-–µ</option>
                        </select>
                    </div>
                </div>

                <button onclick="search()" class="search-btn">–ù–∞–π—Ç–∏</button>
            </div>
        </div>

        <div id="results"></div>

        <h2>–ú–æ–π —Å–ø–∏—Å–æ–∫ ({{ my_list|length }})</h2>
        {% if my_list|length == 0 %}
            <p style="text-align:center; color:#888;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–π–¥–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏ –¥–æ–±–∞–≤—å –≤ —Ç—Ä–µ–∫–µ—Ä!</p>
        {% endif %}
        <div class="my-list">
            {% for item in my_list %}
            <div class="card">
                {% if item.poster_url and item.poster_url != 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞' %}
                <img src="{{ item.poster_url }}" alt="{{ item.title }}">
                {% else %}
                <img src="https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞" alt="–ù–µ—Ç –ø–æ—Å—Ç–µ—Ä–∞">
                {% endif %}
                <h3>{{ item.title }}</h3>
                <p>{{ item.year or '–ì–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' }}</p>
                <p class="status">{{ item.status | capitalize }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        async function search() {
            const q = document.getElementById('query').value.trim();
            if (!q || q.length < 3) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                return;
            }

            const type = document.getElementById('type').value;
            const year = document.getElementById('year').value;

            let url = `/api/search?q=${encodeURIComponent(q)}`;
            if (type) url += `&type=${type}`;
            if (year) url += `&year=${year}`;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="no-results">–ò—â–µ–º...</p>';

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<p class="no-results">${data.error}</p>`;
                    return;
                }

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî<br>–ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>';
                    return;
                }

                let html = '<div class="results">';
                data.results.forEach(item => {
                    const poster = item.poster_url.includes('placeholder') ? 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞' : item.poster_url;
                    const typeText = item.media_type === 'movie' ? '–§–∏–ª—å–º' : '–°–µ—Ä–∏–∞–ª';
                    const safeTitle = item.title.replace(/"/g, '&quot;');

                    html += `
                    <div class="card">
                        <img src="${poster}" alt="${safeTitle}">
                        <h3>${safeTitle}</h3>
                        <p>${item.year || '–ì–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                        <p>${typeText}</p>
                        <button class="add-btn" onclick='addToList("${item.imdb_id}", "${safeTitle}", "${item.year || ''}", "${item.media_type}", "${poster}")'>
                            –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç—Ä–µ–∫–µ—Ä
                        </button>
                    </div>`;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = '<p class="no-results">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
            }
        }

        async function addToList(imdb_id, title, year, media_type, poster_url) {
            try {
                const response = await fetch('/api/my-list', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        imdb_id,
                        title,
                        year,
                        media_type,
                        poster_url: poster_url.includes('placeholder') ? null : poster_url
                    })
                });

                if (response.ok) {
                    alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç—Ä–µ–∫–µ—Ä!');
                    location.reload();
                } else {
                    const err = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (err.detail || '–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ'));
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('query').addEventListener('keypress', e => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>