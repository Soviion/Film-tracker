<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π —Ç—Ä–µ–∫–µ—Ä —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üé¨ –ú–æ–π —Ç—Ä–µ–∫–µ—Ä —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤</h1>

        <div class="search">
            <input type="text" id="query" placeholder="–ü–æ–∏—Å–∫: Matrix 1999, Breaking Bad, –ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä...">
            <button onclick="search()">–ù–∞–π—Ç–∏</button>
        </div>

        <div id="results"></div>

        <h2>–ú–æ–π —Å–ø–∏—Å–æ–∫ ({{ my_list|length }})</h2>
        {% if my_list|length == 0 %}
            <p style="text-align:center; color:#888;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–π–¥–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏ –¥–æ–±–∞–≤—å –≤ —Ç—Ä–µ–∫–µ—Ä!</p>
        {% endif %}
        <div class="my-list">
            {% for item in my_list %}
            <div class="card">
                {% if item.poster_url and item.poster_url != 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞' %}
                <img src="{{ item.poster_url }}" alt="{{ item.title }}">
                {% else %}
                <img src="https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞" alt="–ù–µ—Ç –ø–æ—Å—Ç–µ—Ä–∞">
                {% endif %}
                <h3>{{ item.title }}</h3>
                <p>{{ item.year or '–ì–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' }}</p>
                <p class="status">{{ item.status | capitalize }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        async function search() {
            const q = document.getElementById('query').value.trim();
            if (!q) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="no-results">–ò—â–µ–º...</p>';

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                const data = await res.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<p class="no-results">${data.error}</p>`;
                    return;
                }

                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî<br>–ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ + –≥–æ–¥)</p>';
                    return;
                }

                let html = '<div class="results">';
                data.results.forEach(item => {
                    const poster = item.poster_url && item.poster_url !== 'N/A' 
                        ? item.poster_url 
                        : 'https://via.placeholder.com/300x450?text=–ù–µ—Ç+–ø–æ—Å—Ç–µ—Ä–∞';
                    const type = item.media_type === 'movie' ? '–§–∏–ª—å–º' : '–°–µ—Ä–∏–∞–ª';
                    const safeTitle = item.title.replace(/"/g, '&quot;');

                    html += `
                    <div class="card">
                        <img src="${poster}" alt="${safeTitle}">
                        <h3>${safeTitle}</h3>
                        <p>${item.year || '–ì–æ–¥ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                        <p>${type}</p>
                        <button class="add-btn" onclick='addToList("${item.imdb_id}", "${safeTitle}", "${item.year || ''}", "${item.media_type}", "${poster}")'>
                            –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç—Ä–µ–∫–µ—Ä
                        </button>
                    </div>`;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (err) {
                resultsDiv.innerHTML = '<p class="no-results">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>';
            }
        }

        async function addToList(imdb_id, title, year, media_type, poster_url) {
            try {
                const response = await fetch('/api/my-list', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        imdb_id,
                        title,
                        year,
                        media_type,
                        poster_url: poster_url.includes('placeholder') ? null : poster_url
                    })
                });

                if (response.ok) {
                    alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç—Ä–µ–∫–µ—Ä!');
                    location.reload();
                } else {
                    const err = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (err.detail || '–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ'));
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ Enter
        document.getElementById('query').addEventListener('keypress', e => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>